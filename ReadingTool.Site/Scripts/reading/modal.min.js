var SelectedWord=function(){function n(n,t,i){this.settings=n,this.element=t,this.length=1,$(".modal-footer").removeClass("failed"),t.nodeName=="A"&&(this.element=$(t).parent()),this.selectedWord=$(this.element).hasClass(this.settings.classes.multiClass)?$(this.element).data("phrase"):$(this.element).text(),this.selectedSentence=this.getCurrentSentence(),i?this.quicksave():this.findTerm()}return n.prototype.findTerm=function(){var n=this;$("#currentBox").removeClass().addClass("badge"),$.post(routes.reading.findTerm,{languageId:this.settings.languageId,termPhrase:this.selectedWord},function(t){n.updateModalDisplay(),n.createTemplate(t.data)})},n.prototype.createTemplate=function(n){var r=termUlTemplate(n),u=termDivTemplate(n),f=termMessageTemplate(n),i,t;for($("#tabTermDefintions").html(r),$("#tabContent").html(u),$("#termMessages").html(f),$("#currentBox").html(n.box),$("#termMessage").html(n.message),$("#termId").val(n.id),n.id=="00000000-0000-0000-0000-000000000000"&&$("#termMessage").removeClass("label-info").addClass("label-warning"),n.stateClass==this.settings.classes.knownClass?$("#knownState").attr("checked",!0):n.stateClass==this.settings.classes.unknownClass?$("#unknownState").attr("checked",!0):n.stateClass==this.settings.classes.ignoredClass?$("#ignoredState").attr("checked",!0):$("#notseenState").attr("checked",!0),i=0;i<n.individualTerms.length;i++)t=n.individualTerms[i],$("#sentence"+t.id).val(t.sentence),$("#baseTerm"+t.id).val(t.baseTerm),$("#romanisation"+t.id).val(t.romanisation),$("#definition"+t.id).val(t.definition),$("#tags"+t.id).val(t.tags),t.id=="00000000-0000-0000-0000-000000000000"&&($("#itermMessage"+i).removeClass("label-info").addClass("label-important"),$("#sentence"+t.id).val(this.selectedSentence));$("#tabTermDefintions a:first").tab("show"),$("#itermMessage0").show()},n.prototype.updateModalDisplay=function(){$("#selectedWord").text(this.selectedWord),$("#termPhrase").val(this.selectedWord),this.refreshDictionaryLinks()},n.prototype.quicksave=function(){var n=this;$.post(routes.reading.quickSave,{languageId:this.settings.languageId,termPhrase:this.selectedWord},function(t){console.log("quicksaving"),t.result=="OK"&&n.updateTermClasses(t.data.termPhrase,t.data.term)})},n.prototype.changeState=function(n){switch(n){case"known":$("#knownState").attr("checked",!0);break;case"notknown":$("#unknownState").attr("checked",!0);break;case"ignored":$("#ignoredState").attr("checked",!0);break;case"notseen":$("#notseenState").attr("checked",!0)}},n.prototype.saveChanges=function(){var n=this,t=$("#tabTermDefintions li.active").index();t<0&&(t=1),$("#iconResult").hide(),$(".modal-footer").removeClass("failed"),$.post(routes.reading.saveTerm,$("#formTerms").serialize(),function(i){console.log("saving term changes"),console.log(i),i.result=="OK"?($("#termMessage").removeClass("label-info").addClass("label-success").html(i.message),n.createTemplate(i.data.term),$("#tabTermDefintions a").eq(t).tab("show"),n.updateModalDisplay(),$("#iconResult").removeClass().addClass("icon-ok-circle").show().fadeOut(2e3),n.updateTermClasses(i.data.termPhrase,i.data.term)):($("#termMessage").removeClass().addClass("label label-important").html(i.message),$(".modal-footer").addClass("failed"),$("#iconResult").removeClass().addClass("icon-exclamation-sign icon-white").show().fadeOut(2e3))})},n.prototype.updateTermClasses=function(n,t){var i,r,f,u;if(t.length==1)$("#textContent ."+n).removeClass(this.settings.classes.knownClass+" "+this.settings.classes.unknownClass+" "+this.settings.classes.ignoredClass+" "+this.settings.classes.notseenClass+" box1 box2 box3 box4 box5 box6 box7 box8 box9").addClass(t.stateClass==this.settings.classes.unknownClass?"box"+t.box+" "+t.stateClass:t.stateClass),$("#textContent ."+n).each(function(n,i){var r=$(i).text();$(i).html((t.definition.length>0?'<a title="'+t.definition+'">':"")+r+(t.definition.length>0?"<\/a>":""))});else{if(i=$(this.element),r="<span",r+=' class="'+t.id+" "+this.settings.classes.multiClass+" "+t.stateClass+'"',r+=' data-id="'+t.id+'"',r+=' data-phrase="'+n+'"',r+=">"+t.length+"<\/span>",i.prev().length==0)console.log("beginning of sentence or sup"),i.text()==t.length?(console.log("replacing span"),$(i).parent().html(r)):(console.log("adding sup"),$(i).parent().prepend("<sup>"+r+"<\/sup>"));else if(i.prev().length>0){for(f=!1,u=i.prev();u.length>0&&!f;){if(u.text()==t.length){f=!0;break}u=u.prev()}console.log("has previous sup"),f?(console.log("update existing sup ",u.text()),$(u).html(r)):(console.log("prepend new"),i.prev()[0].nodeName=="SUP"?(console.log("prepend new sup"),$(i).prev().before("<sup>"+r+"<\/sup>")):(console.log("prepend new no sup"),$(i).before("<sup>"+r+"<\/sup>")))}$("#textContent sup ."+t.id).removeClass(this.settings.classes.knownClass+" "+this.settings.classes.unknownClass+" "+this.settings.classes.ignoredClass+" "+this.settings.classes.notseenClass+" box1 box2 box3 box4 box5 box6 box7 box8 box9").addClass(t.stateClass==this.settings.classes.unknownClass?"box"+t.box:t.stateClass),$("#textContent sup ."+t.id).each(function(n,i){var r=$(i).text();$(i).html((t.definition.length>0?'<a title="'+t.definition+'">':"")+r+(t.definition.length>0?"<\/a>":""))})}},n.prototype.resetTerm=function(){var n=this,t=$("#tabTermDefintions li.active").index();t<0&&(t=1),$("#iconResult").hide(),$.post(routes.reading.resetTerm,{languageId:this.settings.languageId,termPhrase:this.selectedWord},function(i){console.log("reset term"),console.log(i),i.result=="OK"?($("#termMessage").removeClass("label-info").addClass("label-success").html(i.message),n.createTemplate(i.data.term),$("#tabTermDefintions a").eq(t).tab("show"),n.updateModalDisplay(),$("#iconResult").removeClass().addClass("icon-ok-circle").show().fadeOut(2e3),n.updateTermClasses(i.data.termPhrase,i.data.term)):($("#termMessage").removeClass().addClass("label label-important").html(i.message),$(".modal-footer").addClass("failed"),$("#iconResult").removeClass().addClass("icon-exclamation-sign icon-white").show().fadeOut(2e3))})},n.prototype.refreshSentence=function(n){console.log("refresh sentence"),this.sentence=this.getCurrentSentence(),$(n).hasClass("refresh")||$(n).addClass("refresh"),$(n).val(this.sentence),this.updateModalDisplay()},n.prototype.increaseWord=function(){(console.log("increase word"),this.length>=7)||(this.length++,this.changePhrase(),this.findTerm())},n.prototype.decreaseWord=function(){(console.log("decrease word"),this.length<=1)||(this.length--,this.changePhrase(),this.findTerm())},n.prototype.refreshDictionaryLinks=function(){var n=this;$(".dictionary").each(function(t,i){var r=$(i),e=r.data("id"),o=r.data("parameter"),s=r.data("urlencode"),h=r.data("url"),u=r.data("autoopen"),f=o=="sentence"?n.selectedSentence:n.selectedWord;u==undefined&&(u=!1),s?$.post(routes.reading.encodeTerm,{languageId:n.settings.languageId,dictionaryId:e,input:f},function(n){n.result=="OK"&&(r.attr("href",n.message),u&&r[0].click())}):(r.attr("href",h.replace("###",f)),u&&r[0].click())})},n.prototype.changePhrase=function(){var i="",r=0,n=$(this.element),t;n.hasClass(this.settings.classes.multiClass)&&(n=n.parent().next()),t=0;do{if(t++,n==null)break;if(n.attr("class")==this.settings.classes.spaceClass||n.attr("class")==this.settings.classes.punctuationClass||n.attr("class")==this.settings.classes.multiClass||n.is("sup")){n=n.next();continue}i+=n.text()+" ",n=n.next(),r++}while(r<this.length&&t<200);this.selectedWord=i,this.updateModalDisplay()},n.prototype.getCurrentSentence=function(){var t,r;console.log("get current sentence");var i=$(this.element).closest(".sentence"),u=i.children(),n=this.buildSentence(u);return n.length<25&&(t=i.prev(),t!=null&&(n=this.buildSentence(t.children())+" "+n)),n.length<25&&(r=i.next(),t!=null&&(n=n+" "+this.buildSentence(r.children()))),console.log("get current sentence: ",n),n},n.prototype.buildSentence=function(n){var t="";return n.each(function(n,i){if(i.nodeName!="SUP"){var r=i.textContent;r==""&&(r=i.innerText),t+=r}}),$.trim(t)},n.prototype.blankModal=function(){$("#termId").val(""),$("#termPhrase").val(""),$("#tabTermDefintions").html(""),$("#tabContent").html(""),$("#termMessages").html(""),$("#selectedWord").html("")},n.prototype.deleteITerm=function(n){var t=this,i;$("#iconResult").hide(),i=1,$(".modal-footer").removeClass("failed"),$.post(routes.reading.deleteIndividualTerm,{termId:$("#termId").val(),individualTermId:n},function(r){console.log("deleting iterm ",n),r.result=="OK"?($("#termMessage").removeClass("label-info").addClass("label-success").html(r.message),t.createTemplate(r.data.term),$("#tabTermDefintions a").eq(i).tab("show"),t.updateModalDisplay(),$("#iconResult").removeClass().addClass("icon-ok-circle").show().fadeOut(2e3),t.updateTermClasses(r.data.termPhrase,r.data.term)):($("#termMessage").removeClass().addClass("label label-important").html(r.message),$(".modal-footer").addClass("failed"),$("#iconResult").removeClass().addClass("icon-exclamation-sign icon-white").show().fadeOut(2e3))})},n}()